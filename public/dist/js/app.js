angular.module("FRCdozer",["ui.router","angularUtils.directives.dirPagination"]).config(["paginationTemplateProvider",function(a){a.setPath("views/paginate.html")}]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("home",{url:"/",templateUrl:"views/home.html"}).state("me",{url:"/me",templateUrl:"views/me.html"}).state("login",{url:"/login",templateUrl:"views/login.html"}).state("register",{url:"/register",templateUrl:"views/register.html"}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("401",{url:"/401",templateUrl:"views/401.html"}).state("game",{url:"/game/:name?filter&reverse",templateUrl:"views/game.html",controller:"frcCtrl"}).state("game.edit",{url:"/edit",templateUrl:"views/edit.html"}).state("game.submissions",{url:"/subs",templateUrl:"views/subs.html"}).state("game.add",{url:"/add",templateUrl:"views/add.html"}).state("game.teams",{url:"/teams",templateUrl:"views/teams.html"}).state("game.team",{url:"/team/:num",templateUrl:"views/team.html",controller:["$stateParams","$scope",function(a,b){b.teamNum=a.num}]}).state("game.match",{url:"/match/:id",templateUrl:"views/match.html",controller:["$stateParams","$scope",function(a,b){b.matchId=a.id}]}).state("game.sub",{url:"/sub/:id",templateUrl:"views/sub.html",controller:["$scope","$stateParams",function(a,b){a.subId=b.id}]}).state("game.matches",{url:"/matches",templateUrl:"views/matches.html"}).state("game.advanced",{url:"/advanced",templateUrl:"views/advanced.html"}),b.when("/g/:name","/game/:name").when("","/").otherwise("/404")}]).controller("mainCtrl",["$scope","$http","$timeout",function(a,b,c){a.user=void 0,a.errors={},a.successes={},a.handle=function(b,d){void 0!==d?(console.log(d),a.errors[b]=d,c(function(){delete a.errors[b]},3e3)):(a.successes[b]=!0,c(function(){delete a.successes[b]},3e3))},a.userInit=function(){b.get("api/hello").success(function(b){a.user=b,a.handle("init")}).error(function(b,c){401===c&&(a.user=void 0),a.handle("init",b)})},a.addGame=function(c){return a.user&&c&&c.name?(c.teams=c.teams||[],c.submissions=c.submissions||[],void b.post("api/game",c).success(function(b){a.newGame={},console.log(b),a.user.games.push(b)}).error(function(b){a.newGame={},console.log(b)})):!1},a.delGame=function(c){confirm("Are you sure you want to delete "+c+"?")&&b["delete"]("api/game/"+c).success(function(){for(var b in a.user.games)c===a.user.games[b].name&&a.user.games.splice(b,1)}).error(function(a){console.log(a)})},a.changePassword=function(c){b.put("api/password",{password:c}).success(function(){a.handle("changePassword")}).error(function(b){a.handle("changePassword",b)})},a.login=function(c,d){b.post("api/login",{username:c,password:d}).success(function(b){a.userName="",a.password="",a.user=b,a.handle("login")}).error(function(b){a.handle("login",b)})},a.logout=function(){b.post("api/logout").success(function(){a.handle("logout"),a.user=void 0}).error(function(b){a.handle("logout",b)})},a.register=function(c,d){b.post("api/register",{username:c,password:d}).success(function(){a.handle("register"),a.login(c,d)}).error(function(b){a.handle("register",b)})},a.back=function(){window.history.back()},a.userInit()}]),angular.module("FRCdozer").config(["$httpProvider",function(a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]).controller("frcCtrl",["$scope","$http","$stateParams","$state","$location",function(a,b,c,d){function e(){a.$apply(function(){a.connected=!1})}function f(){a.$apply(function(){a.connected=!0})}function g(b){var c={},d={};c[b.alliances.blue.teams[0].slice(3)]=!0,c[b.alliances.blue.teams[1].slice(3)]=!0,c[b.alliances.blue.teams[2].slice(3)]=!0,d[b.alliances.red.teams[0].slice(3)]=!0,d[b.alliances.red.teams[1].slice(3)]=!0,d[b.alliances.red.teams[2].slice(3)]=!0;var e={level:b.comp_level,number:b.match_number,set:b.set_number};return{matchObj:e,match:a.serializeMatch(e),time:Number(1e3*b.time),blue:{score:b.alliances.blue.score>0?b.alliances.blue.score:0,teams:c},red:{score:b.alliances.red.score>0?b.alliances.red.score:0,teams:d},noAlliance:[],videos:b.videos}}function h(){a.socket=io(window.location.origin+"/game?name="+a.curGame.name,{path:window.location.pathname+"socket.io/","force new connection":!0}).on("message",function(a){console.log(a)}).on("connect",f).on("connect_error",e).on("reconnect",f).on("disconnect",e).on("connect_timeout",e).on("reconnecting",e).on("reconnect_error",e).on("reconnect_failed",e).on("newSub",function(b){a.$apply(function(){a.appendSubs([b])})}).on("newTeam",function(b){a.$apply(function(){a.changeTeam(b)})}).on("delSub",function(b){a.$apply(function(){a.removeSub(b._id)})}).on("delTeam",function(b){a.$apply(function(){a.removeTeam(b)})}).on("editSub",function(b){a.$apply(function(){a.changeSub(b)})}).on("editTeam",function(b){a.$apply(function(){a.changeTeam(b)})}).on("editGame",function(b){a.$apply(function(){a.changeGame(b)})}).on("resetSubs",function(){a.$apply(function(){a.resetSubs()})}).on("resetTeams",function(){a.$apply(function(){a.resetTeams()})}).on("TBAverification",function(b){a.$apply(function(){a.curGame.verification=b})}).on("TBAping",function(b){a.$apply(function(){console.log(b)})}).on("editMatch",function(b){a.$apply(function(){return b.message_data.match.event_key===a.curGame.tbakey?void a.changeMatch(g(b.message_data.match)):void console.log("Not using match score beacuase wrong event key",b)})}).on("upcomingMatch",function(b){a.$apply(function(){var c={};c.match=b.message_data.match_key.split("_")[1],c.matchObj=a.deserializeMatch(c.match),c.predictedTime=b.message_data.predicted_time,c.scheduledTime=b.message_data.scheduled_time,a.nextMatch=c})}).on("error",function(a){console.log(a)})}a.location=window.location,a.authlevel=1,a.subs=[],a.sub={},a.matches=[],a.match={},a.add={},a.game={},a.curGame={},a.games=[],a.sample={},a.teams=[],a.team={},a.newTeam={},a.filt=d.params.filter||"",a.filters={},a.revr=d.params.reverse||!1,a.connected=!1,a.newTeam={},a.getDate=function(a){if(a){var b=new Date(1e3*parseInt(a.substring(0,8),16));return b}},a.unfilt=function(){a.filt="",a.revr=!1},a.sort=function(b,c,d){return d=d?d:b,a.filters[c]?void(a.filters[c].key===b?(a.filters[c].reverse=!a.filters[c].reverse,a.filters[c].name=d):(a.filters[c].key=b,a.filters[c].reverse=!1,a.filters[c].name=d)):void(a.filters[c]={key:b,reverse:!1,name:d})},a.changeGame=function(b){a.curGame=b},a.appendSubs=function(b){for(var c in b)a.subs.push(a.fixSub(b[c]));a.sortTeams(),a.sortMatches()},a.fixSub=function(b){b.matchObj=b.matchObj||a.deserializeMatch(b.match),b.calc=b.calc||{},b.elements=b.elements||{};for(var c in a.curGame.game)ele=a.curGame.game[c],"Boolean"===ele.type?b.elements[ele.name]=b.elements[ele.name]||!1:"Number"===ele.type&&(b.elements[ele.name]=b.elements[ele.name]||0);return b.calc=a.getValues(b.elements),b},a.appendTeam=function(b){a.teams.push(a.fixTeam(b)),a.sortMatches()},a.removeSub=function(b){for(var c in a.subs)if(b===a.subs[c]._id){a.subs.splice(c,1),a.sortTeams(),a.sortMatches();break}},a.removeTeam=function(b){for(var c in a.teams)if(a.teams[c]._id===b._id){a.teams.splice(c,1);break}},a.changeSub=function(b){for(var c in a.subs)if(b._id===a.subs[c]._id){a.subs[c]=a.fixSub(b);break}a.sortTeams(),a.sortMatches()},a.changeMatch=function(b){if(b.match){b.matchObj=b.matchObj||a.deserializeMatch(b.match);for(var c in a.matches)if(b.match===a.matches[c].match){b.time=b.time?b.time:a.matches[c].time;for(var d in b.blue.teams)b.blue.teams.hasOwnProperty(d)&&(b.blue.teams[d]="object"==typeof a.matches[c].blue.teams[d]?a.matches[c].blue.teams[d]:b.blue.teams[d]);for(var e in b.red.teams)b.red.teams.hasOwnProperty(e)&&(b.red.teams[e]="object"==typeof a.matches[c].red.teams[e]?a.matches[c].red.teams[e]:b.red.teams[e]);return void(a.matches[c]=a.fixMatch(b))}a.matches.push(b)}},a.fixMatch=function(b){return b.matchObj=b.matchObj||a.deserializeMatch(b.match),b.blue.calc=a.matchCalcs(b.blue.teams),b.red.calc=a.matchCalcs(b.red.teams),b.winner=a.winnerString(b.blue.score,b.red.score),b},a.resetSubs=function(){return confirm("Are you sure you want to clear all submissions for "+a.curGame.name+"?")?void b["delete"]("api/game/"+a.curGame._id+"/sub").success(function(){a.subs=[],a.sortMatches(),a.sortTeams()}).error(function(a){console.log("Error resetting subs",a)}):!1},a.resetTeams=function(){return confirm("Are you sure you want delete all teams for "+a.curGame.name+"?")?void b["delete"]("api/game/"+a.curGame._id+"/team").success(function(){a.teams=[],a.sortMatches(),a.sortTeams()}).error(function(a){console.log("Error resetting subs",a)}):!1},a.tbaGrabTeams=function(){b.get("api/tbaproxy/event/"+a.curGame.tbakey+"/teams?X-TBA-App-Id=frc4118:scouting:1").success(function(b){for(var c in b){var d={team:b[c].team_number,name:b[c].nickname};for(var e in a.teams)Number(a.teams[e].team)===Number(d.team)&&(d._id=a.teams[e]._id);a.editTeam(d)}}).error(function(a){console.log(a)})},a.changeTeam=function(b){for(var c in a.teams)if(Number(a.teams[c].team)===Number(b.team))return console.log("found"),a.teams[c].name=b.name,a.teams[c].notes=b.notes,a.teams[c]._id=b._id||void 0,a.teams[c]=a.fixTeam(a.teams[c]),!1;return a.appendTeam(b),!0},a.editTeam=function(c,d){if(d){var e=d.target.form.elements.files.files[0],f="api/game/"+a.curGame._id+"/team/"+c._id+"/pic",g=new FormData;g.append("pic",e),b.post(f,g,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(b){c.pic=b,a.changeTeam(c)}).error(function(a){console.log(a)})}var h;h=c._id?b.put("api/game/"+a.curGame._id+"/team/"+c._id,c):b.post("api/game/"+a.curGame._id+"/team",c),h.success(function(b){a.newTeam={},a.handle("editTeam"),a.changeTeam(b)}).error(function(b){a.handle("editTeam",b)})},a.getMatch=function(b){for(var c in a.matches)if(a.matches[c].match===b.toLowerCase())return a.matches[c]},a.sortMatches=function(){var b=a.subs,c=a.matches;for(var d in c){c[d].noAlliance=[],c[d].blue||(c[d].blue={teams:{},score:0}),c[d].red||(c[d].red={teams:{},score:0});for(var e in c[d].blue.teams)c[d].blue.teams.hasOwnProperty(e)&&c[d].blue.teams[e]!==!0&&delete c[d].blue.teams[e];for(var f in c[d].red.teams)c[d].red.teams.hasOwnProperty(f)&&c[d].red.teams[f]!==!0&&delete c[d].red.teams[f]}a:for(var g in b)if(b[g].match){for(var h in c)if(c[h].match===b[g].match.toLowerCase()){"Blue"===b[g].side?c[h].blue.teams[b[g].team]=b[g]:"Red"===b[g].side?c[h].red.teams[b[g].team]=b[g]:c[h].noAlliance.push(b[g]);continue a}var i={};"Blue"===b[g].side?(i[b[g].team]=b[g],c[c.length]={match:b[g].match.toLowerCase(),matchObj:a.deserializeMatch(b[g].match),blue:{teams:i},red:{teams:{}},noAlliance:[]}):"Red"===b[g].side?(i[b[g].team]=b[g],c[c.length]={match:b[g].match.toLowerCase(),matchObj:a.deserializeMatch(b[g].match),red:{teams:i},blue:{teams:{}},noAlliance:[]}):c[c.length]={match:b[g].match.toLowerCase(),matchObj:a.deserializeMatch(b[g].match),red:{teams:{}},blue:{teams:{}},noAlliance:[b[g]]}}for(var j in c)c[j]=a.fixMatch(c[j]);a.matches=c},a.matchTeams=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&a[c]!==!0&&(b[b.length]=a[c]);return b},a.matchSort=[function(a){var b=a.matchObj.level;return"qm"===b||"q"===b?1:"qf"===b?2:"sf"===b?3:"f"===b?4:0},function(a){return a.matchObj.set},function(a){return a.matchObj.number}],a.serializeMatch=function(a){var b="";return"object"==typeof a&&(b="qm"!==a.level&&a.set?a.level+a.set+"m"+a.number:a.level+a.number),b},a.deserializeMatch=function(a){var b={};if(!a)return{};var c;for(c=0;c<a.length;c++)if(!isNaN(a[c])){b.level=a.slice(0,c).toLowerCase();break}for(var d=c;d<a.length;d++)if(isNaN(a[d])){b.set=Number(a.slice(c,d));break}return b.set?b.number=Number(a.slice(d+1)):(b.set=1,b.number=Number(a.slice(c))),b},a.getVideoUrl=function(a){switch(a.type){case"youtube":return"https://www.youtube.com/watch?v="+a.key}},a.tbaGrabMatches=function(){b.get("api/tbaproxy/event/"+a.curGame.tbakey+"/matches?X-TBA-App-Id=frc4118:scouting:1").success(function(b){for(var c in b)a.changeMatch(g(b[c]));a.sortMatches()}).error(function(a){console.log(a)})},a.matchCalc=function(b,c){var d=0;for(var e in b)b.hasOwnProperty(e)&&b[e]!==!0&&(d+=a.getValue(b[e].elements,c));return d},a.matchCalcs=function(b){var c={};for(var d in a.curGame.calc)c[a.curGame.calc[d].name]=a.matchCalc(b,a.curGame.calc[d].elements);return c},a.getGame=function(a,c){b.get("api/game/"+a).success(function(a){c(null,a)}).error(function(a,b){c({message:a,status:b},null)})},a.createGame=function(a,c){b.post("api/game",params).success(function(a){c(null,a)}).error(function(a){c(a,null)})},a.getSubs=function(c,d){b.get("api/game/"+(c||a.curGame._id)+"/sub").success(function(b){a.handle("getSubs"),a.subs=b,a.sortMatches(),a.sortTeams(),d()}).error(function(b){a.handle("getSubs",b)})},a.getTeams=function(c){b.get("api/game/"+(c||a.curGame._id)+"/team").success(function(b){a.handle("getSubs");for(var c in b)a.changeTeam(b[c])}).error(function(b){a.handle("getSubs",b)})},a.deleteGame=function(a,c){b["delete"]("api/game/"+a).success(function(a){c(null,a)}).error(function(a){c(a,null)})},a.getSub=function(b){for(var c in a.subs)if(a.subs[c]._id===b)return a.subs[c]},a.getTeam=function(b){b=Number(b);for(var c in a.teams)if(Number(a.teams[c].team)===b)return a.teams[c];return{team:b,name:""}},a.editSub=function(c){b.put("api/game/"+a.curGame._id+"/sub/"+c._id,c).success(function(){a.handle("editSub"),a.connected||a.changeSub(data)}).error(function(b){a.handle("editSub",b)})},a.addSub=function(c){b.post("api/game/"+a.curGame._id+"/sub",c).success(function(){a.add={},a.handle("newSub"),a.connected||a.appendSubs([data])}).error(function(b){a.handle("newSub",b)})},a.delSub=function(c){b["delete"]("api/game/"+a.curGame._id+"/sub/"+c).success(function(){a.handle("delSub"),a.connected||a.removeSub(c)}).error(function(b){a.handle("delSub",b)})},a.delTeam=function(c){b["delete"]("api/game/"+a.curGame._id+"/team/"+c).success(function(){a.handle("delTeam"),a.connected||a.removeTeam(data)}).error(function(b){a.handle("delTeam",b)})},a.editGame=function(c){c.teams=void 0,c.submissions=void 0,b.put("api/game/"+c._id,c).success(function(b){a.handle("editGame"),a.connected||a.chanVgeGame(b)}).error(function(b){a.handle("editGame",b)})},a.downloads={},a.subsToCSV=function(b){var c="Match,Team,Alliance";for(var d in a.curGame.game)c+=","+a.curGame.game[d].name;for(var e in a.curGame.calc)c+=","+a.curGame.calc[e].name;c+="\n";for(var f in b){c+=b[f].match.toLowerCase()+",",c+=b[f].team+",",c+=b[f].side;for(var g in a.curGame.game)c+=","+(b[f].elements[a.curGame.game[g].name]||"");for(var h in a.curGame.calc)c+=","+(a.getValue(b[f].elements,a.curGame.calc[h].elements)||0);c+="\n"}return c},a.stringify=JSON.stringify,a.confirm=function(a){confirm(a)},a.download=function(b,c,d){var e=new Blob([c],{type:(d||"text/plain")+";charset=utf-8;"}),f=(window.URL||window.webkitURL).createObjectURL(e);a.downloads[b]=f},a.getValue=function(a,b){a=a||{},b=b||[];var c=0;for(var d in b)c+=Number(a[b[d].name])*b[d].worth||0;return Math.round(100*c)/100||0},a.getValues=function(b){var c={};for(var d in a.curGame.calc)c[a.curGame.calc[d].name]=a.getValue(b,a.curGame.calc[d].elements);return c},a.sortTeams=function(){var b=a.teams,c=a.subs;for(var d in b)b[d].subs=[];a:for(var e in c){for(var f in b)if(Number(c[e].team)===Number(b[f].team)){b[f].subs.push(c[e]);continue a}b.push({team:c[e].team,subs:[c[e]]})}for(var g in b)b[g]=a.fixTeam(b[g]);a.teams=b},a.fixTeam=function(b){return b.averages=a.getAverages(b.subs),b.calc=a.getValues(b.averages),b},a.getAverage=function(a,b){b=b||[];var c=0;for(var d in b)c+=Number(b[d].elements[a])||0;return c/=b.length,c=Math.round(100*c)/100||0},a.getAverages=function(b){var c={};for(var d in a.curGame.game)c[a.curGame.game[d].name]=a.getAverage(a.curGame.game[d].name,b);return c},a.init=function(){c.name||d.go("404"),a.getGame(c.name,function(b,c){c?(a.curGame=c,a.teams=c.teams,a.appendSubs(c.submissions),delete a.curGame.submissions,delete a.curGame.teams,h(),a.tbaGrabInfo(),a.tbaGrabMatches()):b&&d.go(401===b.status?"401":"404")})},a.winnerString=function(a,b){return a&&b?a>b?"Blue":b>a?"Red":b===a?"Tie":void 0:""},a.delPermission=function(b){delete a.curGame.permissions.users[b]},a.tbaGrabInfo=function(){b.get("api/tbaproxy/event/"+a.curGame.tbakey+"?X-TBA-App-Id=frc4118:scouting:1").success(function(b){a.tbaResponse=b}).error(function(a){console.log(a)})},a.init()}]);